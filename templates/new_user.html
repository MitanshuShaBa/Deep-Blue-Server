<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>New User</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl"
      crossorigin="anonymous"
    />
    <style media="screen">
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      h1 {
        text-align: center;
        padding-top: 15px;
        padding-bottom: 20px;
        letter-spacing: 4px;
      }

      .main-stream {
        display: block;
        margin-left: 37%;
        margin-right: 25%;
      }

      .form1 {
        display: block;
        text-align: center;
      }
      #streaming {
        height: 265px;
        margin-bottom: 40px;
      }
      #info_form {
        align-content: center;
      }

      .main-form {
        align-content: center;
      }
      .info-form {
        padding-bottom: 10px;
      }
      label {
        display: inline-block;
        width: 100px;
      }
      button {
        padding: 5px 20px;
        margin: 10px;
      }
    </style>
  </head>
  <body>
    <h1>New User Page</h1>
    <div class="main-stream">
      <video id="streaming" type="video/mp4" autoplay></video>
      <button onclick="capture()">Capture</button>
      <canvas id="canvas" hidden="true"></canvas>
    </div>
    <div class="form1">
      <form id="info_form_1">
        <div class="main-form">
          <div class="info-form">
            <label for="name">Name : </label>
            <input id="name" name="name" />
          </div>
          <div class="info-form">
            <label for="dob">Date of Birth : </label>
            <input id="dob" name="dob" type="date" />
          </div>
          <div class="info-form">
            <label for="email">Email : </label>
            <input id="email" name="email" />
          </div>
          <div class="info-form">
            <label for="gender">Gender : </label>
            <select id="gender" name="gender">
              <option value="M">Male</option>
              <option value="F">Female</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="info-form">
            <label for="phone_num">Phone Number : </label>
            <input id="phone_num" name="phone_num" />
          </div>
          <div class="info-form">
            <label for="address">Address : </label>
            <input id="address" name="address" />
          </div>
          <div class="info-form">
            <label for="temp">Temperature : </label>
            <input id="temp" name="temp" />
          </div>
          <div class="info-form">
            <label for="mask">Mask : </label>
            <input id="mask" name="mask" />
          </div>
          <div class="info-form">
            <label for="purpose">Purpose : </label>
            <input id="purpose" name="purpose" />
          </div>
          <div class="info_form">
            <button
              class="btn-primary"
              type="button"
              name="entry"
              onclick="logEntry()"
            >
              Entry
            </button>
          </div>
        </div>
      </form>
    </div>

    <script>
      let streamingDocument = document.getElementById("streaming");
      let nameDiv = document.getElementById("name");
      let dobDiv = document.getElementById("dob");
      let emailDiv = document.getElementById("email");
      let genderDiv = document.getElementById("gender");
      let phoneNumDiv = document.getElementById("phone_num");
      let addressDiv = document.getElementById("address");
      let tempDiv = document.getElementById("temp");
      let maskDiv = document.getElementById("mask");
      let purposeDiv = document.getElementById("purpose");

      let files = [];

      if (navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices
          .getUserMedia({ video: true })
          .then(function (stream) {
            streamingDocument.srcObject = stream;
          })
          .catch(function (error) {
            console.log("Something went wrong!", error);
          });
      }

      function capture() {
        var canvas = document.getElementById("canvas");
        var video = document.getElementById("streaming");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas
          .getContext("2d")
          .drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
        canvas.toBlob((blob) => {
          const file = new File([blob], "name");
          files.push(file);
        });
      }

      fetch("/log")
        .then((response) => {
          return response.json();
        })
        .then((data) => {
          tempDiv.value = data.temp;
          maskDiv.value = data.mask;
        })
        .catch((err) => console.log(err));

      const logEntry = () => {
        const user_data = {
          address: addressDiv.value,
          dob: dobDiv.value,
          email: emailDiv.value,
          gender: genderDiv.value,
          name: nameDiv.value,
          phone_number: phoneNumDiv.value,
          photo_url: "",
          role: "visitor",
        };

        let visit_log_data = {
          temp: tempDiv.value,
          mask: maskDiv.value,
          purpose: purposeDiv.value,
          type: "entry",
        };

        const formData = new FormData();
        formData.append("user_data", JSON.stringify(user_data));
        for (let i = 0; i < files.length; i++) {
          formData.append("photos", files[i]);
        }

        fetch("/create_user", {
          method: "POST",
          body: formData,
        })
          .then((response) => {
            return response.json();
          })
          .then(({ id }) => {
            // We now have a user_id
            visit_log_data["user_id"] = id;

            fetch("/visit_log", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(visit_log_data),
            })
              .then((response) => {
                return response.json();
              })
              .then((data) => {
                console.log(data);

                // fetch("/reset")
                //   .then((response) => response.text())
                //   .then((data) => console.log(data));
              })
              .catch((err) => console.log("error", err));
          });
      };
    </script>
  </body>
</html>
